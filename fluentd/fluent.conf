  <source>
      @type tail
      path /var/log/nginx/access*.log
      exclude_path ["/var/log/nginx/*.gz"]
      format grok
      grok_pattern %{NGINX_ACCESS}
      custom_pattern_path /fluentd/grok
      tag nginx.access
      types status:integer,body_bytes_sent:integer,bytes_sent:integer,upstream_addr:array
  </source>

  <source>
    @type prometheus_monitor
    <labels>
      host ${hostname}
    </labels>
  </source>

  <source>
    @type prometheus
  </source>

  <match nginx.**>
    @type copy
    <store>
      @type stdout
      output_type json
    </store>
    <store>
      @type elasticsearch
      logstash_format true
      host elasticsearch
      buffer_type memory
      flush_interval 1
    </store>
    <store>
      type grep
      regexp1 status ^5\d\d$
      add_tag_prefix error
    </store>
  </match>

  <match error.**>
    @type copy
    <store>
      @type stdout
      output_type json
    </store>
    <store>
      type prometheus
      <metric>
        name api_http_error_requests_total
        type counter
        desc The total number of http request errors
        <labels>
          tag ${tag}
          host ${hostname}
          upstream ${upstream_addr}
        </labels>
      </metric>
    </store>
  </match>
