  <source>
      @type tail
      path /var/log/nginx/access*.log
      exclude_path ["/var/log/nginx/*.gz"]
      format grok
      grok_pattern %{NGINX_ACCESS}
      custom_pattern_path /fluentd/grok
      tag nginx.access
      types status:integer,body_bytes_sent:integer,bytes_sent:integer
  </source>

  <source>
    @type prometheus_monitor
    <labels>
      host ${hostname}
    </labels>
  </source>

  <source>
    @type prometheus
  </source>

  <filter nginx.**>
    @type record_transformer
    enable_ruby
    <record>
      upstream_addr ${upstream_addr.split(",").map { |s| s.strip }}
      upstream_status ${upstream_status.split(",").map { |s| s.strip }}
      upstream_connect_time ${upstream_connect_time.split(",").map { |s| s.strip }}
      upstream_response_length ${upstream_response_length.split(",").map { |s| s.strip }}
      request_time ${request_time.split(",").map { |s| s.strip }}
      upstream_response_time ${upstream_response_time.split(",").map { |s| s.strip }}
      upstream_header_time ${upstream_header_time.split(",").map { |s| s.strip }}
    </record>
  </filter>


  <match nginx.**>
    @type copy
    <store>
      @type stdout
      output_type json
    </store>
    <store>
      @type elasticsearch
      logstash_format true
      host elasticsearch
      buffer_type memory
      flush_interval 1
    </store>
    <store>
      type grep
      regexp1 status ^5\d\d$
      add_tag_prefix error
    </store>
  </match>

  <match error.**>
    @type copy
    <store>
      @type stdout
      output_type json
    </store>
    <store>
      type prometheus
      <metric>
        name api_http_error_requests_total
        type counter
        desc The total number of http request errors
        <labels>
          tag ${tag}
          host ${hostname}
          upstream ${upstream_addr}
        </labels>
      </metric>
    </store>
  </match>
