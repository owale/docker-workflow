  <source>
      @type tail
      path /var/log/nginx/access*.log
      exclude_path ["/var/log/nginx/*.gz"]
      format grok
      grok_pattern %{NGINX_ACCESS}
      custom_pattern_path /fluentd/grok
      tag nginx.access
  </source>

  <source>
    type prometheus
  </source>

  <filter nginx.**>
    @type grep
    input_key status
    exclude 200
    tag http.error
  </filter>

  <match http.error>
    type prometheus
    <metric>
      name api_http_error_requests_total
      type counter
      desc The total number of http request errors
      key foo
      <labels>
        tag ${tag}
        host ${hostname}
        instance ${upstream_addr}
      </labels>
    </metric>
  </match>

  <match nginx.access>
    @type stdout
    output_type json
  </match>

  <match **>
    @type elasticsearch
    logstash_format true
    host elasticsearch
  </match>
